<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group Video Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #videos {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }
    video {
      width: 240px;
      height: 180px;
      background: black;
      border-radius: 0.5rem;
      object-fit: cover;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4">
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg w-80 text-center">
      <h2 class="text-xl mb-4">Enter your name</h2>
      <input id="nameInput" type="text" placeholder="Your name" class="w-full p-2 rounded text-black" />
      <button id="joinBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white w-full">Join</button>
    </div>
  </div>

  <div id="videos" class="mb-4"></div>

  <div class="flex fixed bottom-4 gap-4 mb-4">
    <button id="toggleVideoBtn" class="bg-gray-700 rounded-full hover:bg-gray-600 px-4 py-2">Video</button>
    <button id="toggleChatBtn" class="bg-gray-700 rounded-full hover:bg-gray-600 px-4 py-2">Chat</button>
    <a href="https://beastcut.github.io/Rohit-Unfiltered/study/index.html" class="bg-red-700 rounded-full hover:bg-red-600 px-4 py-2 text-white">Leave</a>
  </div>

  <div id="chatBox" class="fixed right-4 top-16 bottom-4 w-80 bg-gray-800 rounded p-4 flex flex-col hidden shadow-lg">
    <div id="chatMessages" class="flex-grow overflow-y-auto mb-4 space-y-2"></div>
    <form id="chatForm" class="flex gap-2">
      <input id="chatInput" autocomplete="off" placeholder="Type a message..." class="flex-grow p-2 rounded text-black" />
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">Send</button>
    </form>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhIYskdZDrW2lfjGKnflGIbHNlTojoXho",
  authDomain: "videochat-1f348.firebaseapp.com",
  projectId: "videochat-1f348",
  storageBucket: "videochat-1f348.appspot.com",
  messagingSenderId: "1054111027678",
  appId: "1:1054111027678:web:99f547f3fda3bc8d7c4d4f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('nameInput');
const joinBtn = document.getElementById('joinBtn');
const videos = document.getElementById('videos');
const toggleVideoBtn = document.getElementById('toggleVideoBtn');
const toggleChatBtn = document.getElementById('toggleChatBtn');
const chatBox = document.getElementById('chatBox');
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');

const ROOM_ID = "default_room";
let localStream = null;
let peers = {};
let peerNames = {};
let userId = null;
let userName = null;

const roomRef = db.collection('rooms').doc(ROOM_ID);
const usersRef = roomRef.collection('users');
const signalsRef = roomRef.collection('signals');

joinBtn.onclick = async () => {
  const val = nameInput.value.trim();
  if (!val) return alert("Please enter your name");
  userName = val;
  nameModal.style.display = 'none';
  await start();
};

async function start() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  } catch (e) {
    alert("Cannot access camera/mic: " + e.message);
    return;
  }

  addVideoElement('local', localStream, userName + " (You)");
  userId = usersRef.doc().id;
  await usersRef.doc(userId).set({ name: userName, joinedAt: Date.now() });

  usersRef.onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const doc = change.doc;
      const id = doc.id;
      if (id === userId) return;
      peerNames[id] = doc.data().name;
      if (change.type === 'added') createPeerConnection(id, peerNames[id], true);
      else if (change.type === 'removed') {
        removeVideoElement(id);
        if (peers[id]) { peers[id].close(); delete peers[id]; }
      }
    });
  });

  signalsRef.onSnapshot(snapshot => {
    snapshot.docChanges().forEach(async change => {
      const data = change.doc.data();
      if (!data || data.to !== userId) return;
      const fromId = data.from;
      if (data.type === 'offer') await handleOffer(fromId, data.sdp);
      else if (data.type === 'answer') await handleAnswer(fromId, data.sdp);
      else if (data.type === 'candidate') await handleCandidate(fromId, data.candidate);
      signalsRef.doc(change.doc.id).delete();
    });
  });

  roomRef.collection('chat').orderBy('timestamp').onSnapshot(snapshot => {
    chatMessages.innerHTML = "";
    snapshot.docs.forEach(doc => {
      const msg = doc.data();
      const el = document.createElement('div');
      el.className = 'p-1 rounded ' + (msg.senderId === userId ? 'bg-blue-600 self-end' : 'bg-gray-700 self-start');
      el.textContent = `${msg.senderName}: ${msg.text}`;
      chatMessages.appendChild(el);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  toggleVideoBtn.onclick = toggleVideo;
  toggleChatBtn.onclick = () => chatBox.classList.toggle('hidden');
  chatForm.onsubmit = sendMessage;
  window.onbeforeunload = cleanup;
}

function addVideoElement(id, stream, label) {
  if (document.getElementById('container-' + id)) return;
  const container = document.createElement('div');
  container.id = 'container-' + id;
  container.className = 'flex flex-col items-center';
  const video = document.createElement('video');
  video.id = 'video-' + id;
  video.srcObject = stream;
  video.autoplay = true;
  video.playsInline = true;
  video.muted = (id === 'local');
  const nameLabel = document.createElement('div');
  nameLabel.textContent = label;
  nameLabel.className = 'mt-1 text-center text-sm text-gray-300';
  container.appendChild(video);
  container.appendChild(nameLabel);
  videos.appendChild(container);
}

function removeVideoElement(id) {
  const container = document.getElementById('container-' + id);
  if (container) container.remove();
}

async function createPeerConnection(peerId, peerName, isOfferer) {
  if (peers[peerId]) return;
  const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.onicecandidate = e => {
    if (e.candidate) sendSignal({ type: 'candidate', candidate: e.candidate, from: userId, to: peerId });
  };

  pc.ontrack = e => {
    const [stream] = e.streams;
    addVideoElement(peerId, stream, peerName);
  };

  peers[peerId] = pc;

  if (isOfferer) {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendSignal({ type: 'offer', sdp: offer, from: userId, to: peerId });
  }
}

async function handleOffer(fromId, sdp) {
  await createPeerConnection(fromId, peerNames[fromId] || "Peer", false);
  await peers[fromId].setRemoteDescription(new RTCSessionDescription(sdp));
  const answer = await peers[fromId].createAnswer();
  await peers[fromId].setLocalDescription(answer);
  sendSignal({ type: 'answer', sdp: answer, from: userId, to: fromId });
}

async function handleAnswer(fromId, sdp) {
  if (peers[fromId]) await peers[fromId].setRemoteDescription(new RTCSessionDescription(sdp));
}

async function handleCandidate(fromId, candidate) {
  if (peers[fromId]) await peers[fromId].addIceCandidate(new RTCIceCandidate(candidate));
}

function toggleVideo() {
  const videoTrack = localStream.getVideoTracks()[0];
  if (videoTrack) {
    videoTrack.enabled = !videoTrack.enabled;
    toggleVideoBtn.textContent = videoTrack.enabled ? "Video Off" : "Video On";
  }
}

async function sendMessage(e) {
  e.preventDefault();
  const text = chatInput.value.trim();
  if (text) {
    await roomRef.collection('chat').add({ senderId: userId, senderName: userName, text, timestamp: Date.now() });
    chatInput.value = '';
  }
}

async function cleanup() {
  if (userId) await usersRef.doc(userId).delete().catch(() => {});
  Object.values(peers).forEach(pc => pc.close());
  peers = {};
  if (localStream) localStream.getTracks().forEach(track => track.stop());
  removeVideoElement('local');
  nameModal.style.display = 'flex';
}

function sendSignal(data) {
  signalsRef.add(data);
}
</script>
</body>
</html>
