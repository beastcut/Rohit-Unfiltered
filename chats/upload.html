<!DOCTYPE html>
<html lang="en" class="scroll-smooth" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload Post - Admin Only</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-purple-600 via-pink-500 to-red-500 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white bg-opacity-90 rounded-lg shadow-lg p-8 max-w-md w-full">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-900">Upload New Post</h1>
    
    <form id="uploadForm" class="space-y-5">
      <div>
        <label for="title" class="block text-gray-700 font-semibold mb-1">Title</label>
        <input type="text" id="title" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Post title" required />
      </div>
      <div>
        <label for="description" class="block text-gray-700 font-semibold mb-1">Description</label>
        <textarea id="description" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Write your description here" required></textarea>
      </div>
      <div>
        <label for="image" class="block text-gray-700 font-semibold mb-1">Select Image</label>
        <input type="file" id="image" accept="image/*" class="w-full" required />
      </div>
      <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 rounded-md transition duration-300">Upload Post</button>
    </form>

    <p id="status" class="mt-4 text-center text-sm text-gray-700"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config - replace with your own
  const firebaseConfig = {
  apiKey: "AIzaSyAPhlmCS7t_NV7VqhRtOiFGp1QFhLzqMh4",
  authDomain: "chat-7b8fc.firebaseapp.com",
  projectId: "chat-7b8fc",
  storageBucket: "chat-7b8fc.firebasestorage.app",
  messagingSenderId: "604456029175",
  appId: "1:604456029175:web:f61e014fe2113671a7bcf2"
};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Your admin emails here:
    const adminEmails = ["satyampatel.net@gmail.com", "workwithrohitunfiltered@gmail.com"];  // Replace with your admin email(s)

    const status = document.getElementById("status");
    const uploadForm = document.getElementById("uploadForm");

    // ImgBB API key (replace with your real key)
    const imgbbApiKey = "6f06b01143a03ba27c8eecc7ca20ac38";

    // Check if user is admin
    onAuthStateChanged(auth, (user) => {
      if (!user || !adminEmails.includes(user.email)) {
        alert("Access denied. Only admins can upload posts.");
        window.location.href = "upload.html";
      }
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "";
      status.classList.remove("text-red-600");

      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const imageFile = document.getElementById("image").files[0];

      if (!title || !description || !imageFile) {
        status.textContent = "Please fill all fields and select an image.";
        status.classList.add("text-red-600");
        return;
      }

      try {
        status.textContent = "Uploading image to ImgBB...";

        // Convert image file to base64
        const toBase64 = (file) => new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result.split(',')[1]); // get base64 without prefix
          reader.onerror = error => reject(error);
        });

        const base64Image = await toBase64(imageFile);

        // Upload to ImgBB via fetch API
        const formData = new FormData();
        formData.append("key", imgbbApiKey);
        formData.append("image", base64Image);

        const response = await fetch("https://api.imgbb.com/1/upload", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error("Image upload failed.");
        }

        const imageUrl = data.data.url;

        status.textContent = "Saving post data...";

        // Save post info in Firestore
        await addDoc(collection(db, "posts"), {
          title,
          description,
          imageUrl,
          createdAt: serverTimestamp(),
          postedBy: auth.currentUser.email
        });

        status.textContent = "Post uploaded successfully!";
        uploadForm.reset();

      } catch (error) {
        console.error("Error:", error);
        status.textContent = "Upload failed. Please try again.";
        status.classList.add("text-red-600");
      }
    });
  </script>
</body>
</html>
